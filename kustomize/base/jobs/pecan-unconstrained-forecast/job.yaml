kind: Job
apiVersion: batch/v1
metadata:
  name: ctate
  namespace: software-application-innovation-lab-sail-projects-fcd6dfa
  labels:
    job-name: ctate
spec:
  parallelism: 1
  completions: 1
  backoffLimit: 2
  template:
    metadata:
      name: pecan-unconstrained-forecast
      labels:
       job-name: ctate
    spec:
      volumes:
        - name: ctate
          persistentVolumeClaim:
            claimName: ctate
      containers:
        - name: pecan-unconstrained-forecast
          image: 'quay.io/computateorg/pecan-unconstrained-forecast:latest'
          command:
            - Rscript
            - pecan/scripts/HARV_metdownload_efi.R
            - --jumpback=$(( ($(date +%s) - $(date +%s -ud '2023-05-16 00:00:00')) / 3600 / 24 ))
          env:
            - name: MINIO_HOST
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: BUCKET_HOST
            - name: MINIO_PORT
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: BUCKET_PORT
            - name: BUCKET_REGION
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: BUCKET_REGION
            - name: MINIO_BUCKET
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: BUCKET_NAME
            - name: MINIO_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: AWS_ACCESS_KEY_ID
            - name: MINIO_SECRET
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: AWS_SECRET_ACCESS_KEY
            - name: RABBITMQ_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: pecan-rabbitmq
                  key: rabbitmq-password
            - name: RABBITMQ_URI
              value: 'amqp://guest:$(RABBITMQ_PASSWORD)@pecan-rabbitmq/%2F'
            - name: PGHOST
              value: pecan-postgresql.pecan.svc.cluster.local
            - name: PGPORT
              value: '5432'
            - name: PGDATABASE
              value: postgres
            - name: PGUSER
              value: postgres
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: pecan-postgresql
                  key: postgresql-password
            - name: BETYUSER
              value: bety
            - name: BETYPASSWORD
              valueFrom:
                secretKeyRef:
                  name: pecan-betydb
                  key: betyPassword
            - name: BETYDATABASE
              value: bety
            - name: NAME
              value: pecan-server
            - name: FQDN
              value: pecan-server-pecan.apps-crc.testing
            - name: SECRET_KEY_BASE
              valueFrom:
                secretKeyRef:
                  name: pecan-betydb
                  key: secretKey
            - name: PECAN_HOME
              value: /opt/app-root/src/pecan
            - name: NC_DIR
              value: /opt/app-root/src/forecast_example/GEFS-NC
            - name: CLIM_DIR
              value: /opt/app-root/src/forecast_example/GEFS/noaa_clim
            - name: PROJECT_DIR
              value: /opt/app-root/src/forecast_example
            - name: MINIO_SCHEME
              value: https
            - name: MINIO_PUBLIC
              value: 'FALSE'
          resources:
            limits:
              cpu: '1'
              memory: '2Gi'
            requests:
              cpu: '1'
              memory: '2Gi'
          volumeMounts:
            - name: ctate
              mountPath: /opt/app-root/src
          imagePullPolicy: Always
      restartPolicy: Never
